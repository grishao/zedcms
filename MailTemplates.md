# Шаблоны отправки Email #
Отправка email в ZedCMS организованна через очереди, которые хранятся в таблице MySQL **z\_mail\_pool**.

За отправку email отвечает библиотека **`Z_Mail_Send`**, реализующая следующие статические методы:
  * **`Z_Mail_Send::sendTemplate($template_name,$params)`**
  * **`Z_Mail_Send::sendMessage($from, $to, $subject, $text, $additional_headers = array())`**

# Хранение шаблонов #
Шаблоны хранятся в папке сайта **/mail\_templates/** и в папке фреймворка **/mail\_templates/**. Шаблоны фреймворка доступны всем сайтам, а шаблоны сайта, только сайту в котором они находятся.

При поиске шаблона, фреймворк сначала ищет его в папке сайта, а затем в папке фреймворка, если шаблон не найден, генерируется исключение и дальнейшее выполнение останавливается. Таким образом, шаблоны фреймворка можно переопределять в своем сайте.

Шаблоны - это текстовый файл с расширением **.tpl**.

Шаблоны могут находится в подпапках папки **/mail\_templates/**. Тогда при вызове отправки письма нужно указывать путь относительно **/mail\_templates/**. Например, **myfolder/mytemplate.tpl**

# Отправка письма через шаблон #
Письмо отправляется через шаблон вызовом **`Z_Mail_Send::sendTemplate($template_name,$params)`**:
```
Z_Mail_Send::sendTemplate("mytemplate.tpl", array(
   "EMAIL_FROM" => "admin@site.com"),
   "EMAIL_TO" => "test@site.com"),
   "SUBJECT" => "Тестовое сообщение"),
   "MY_PARAM" => "Любая строка.")
);
```

Содержание шаблона **mytemplate.tpl**:
```
FROM: %EMAIL_FROM%
TO: %EMAIL_TO%
SUBJECT: %SUBJECT%
TEXT:
Hello world!<br><br>

%MY_PARAM%

<br><br><br>
--<br>
С уважением,<br>
Администрация
```

Как видно шаблон может содержать HTML код, и параметры переданные в метод **sendTemplate** можно отображать в шаблоне путем обертки их в `%%`.

# Очередь сообщений #
После выполнения метода **`Z_Mail_Send::sendTemplate`**, сообщение ставится в очередь на отправку в таблице Mysql **z\_mail\_pool**. Очередь обрабатывается асинхронно, с помощью [серверного скрипта](ServerScripts.md), который запускается CRON. Таблица **z\_mail\_pool** создается автоматически, если она отсутствует в базе.

# Отправка сообщения без очереди #
Метод **`Z_Mail_Send::sendTemplate($template_name,$params)`** всегда возвращает **id** созданного письма в очереди. И по этому **id** можно осуществить немедленную отправку, вызвав метод **`Z_Mail_Send::processMessageByID($id)`**.

При немедленной отправке, нужно помнить, что выполнение скрипта будет приостановленно на время отправки. Это будет выглядеть в виде паузы перед загрузкой страницы, которая осуществляет отправку. Если это несколько писем, то это может быть незаметным, однако при отправке десятков и сотен писем лучше пользоваться стандартной асинхронной отправкой.

При возникновении ошибки при немедленной отправке письма, письмо останется в очереди и будут произведены повторные попытки отправки этго письма уже в ассинхронном режиме.

# Асинхронная отправка #
Асинхронная отправка осуществляется через [сервеный скрипт](ServerScripts.md), который периодически запускается CRON.

Серверный скрипт должен находиться в папке **/server\_scripts/** сайта.
Для удобства его необходимо назвать **mail.php**:
```
<?
// ЗАПУСКАТЬ ТОЛЬКО С ПАРАМЕТРОМ domain=www.yourdomain.com
// Необходимые вызовы для запуска серверного скрипта
define("Z_CONFIG_FILE",realpath(dirname(__FILE__) . '/../configs/config.ini'));
require(dirname(__FILE__) . '/../../z.common/server_scripts/index.php');

// Отправляем Mailы
Z_Mail_Send::processMessages();
// Отправляем SMSы
Z_SMS_SMS::processMessages();
?>
```

В этом же скрипте можно вызывать отправку очереди SMS. Подробнее в [Шаблоны отправки SMS](SMSTemplates.md)

При вызове серверных скриптов всегда необходимо указывать домен, в качестве параметра, для корректного выбора [конфигурации сайта](SiteConfiguration.md), которая от него может зависеть.
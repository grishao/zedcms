# Z\_Performance Тестирование быстродействия #

Замер быстродействия необходим для поиска "узкого" места при генерации страницы. Эти места могут быть, например, база данных, неоптимизированный обработчик написанный на PHP и т.д.

# Основные понятия #

Для простоты учета потребления времени было введено понятие **событие**. Событием может быть запрос к БД, отрисовка компонента, страницы, шаблона или полностью генерация всей страницы от начала до конца. Событие происходит в определенном промежутке времени, имеет начало и конец. События могут вкладываться друг в друга и пересекаться. Например, событие генерации страницы создержит в себе несколько событий создания компонент, которые в свою очередь могут вызывать события обращения к БД.

События имеют следующие атрибуты:
  * тип события
  * имя события
  * параметры события
  * время начала события
  * время окончания события
  * продолжительность события

В системе уже существуют предопределенные типы событий:
  * framework - событие, которое длится от самого начала до самого конца генерации страницы
  * page - событие, которое начинается в момент начала отрисовки тела страницы и заканчивается непосредственно перед отрисовкой шаблона
  * template - событие, которое начинается сразу после отрисовки страницы (событие page) и заканчивается непосредствнно в конце отрисовки всего ответа вместе с событием framework
  * component - событие, которое начинается в момент вызова компонента (Z\_Component::placeComponent) и заканчивается в конце его полной отрисовки
  * mysql\_db - сообытие, которое связано с обращением к БД mysql, это может быть просто запрос на чтение, на запись, получение результата и т.д.

Тип события всегда называется строчными латинскими буквами без пробелов.

Имя события служит для определения "подсобытий", чтобы лучше ориентироваться в происходящем. Например, **component** в качестве имени использует название компонента и шаблон отрисовки. Имя события **mysql\_db** обозначает операцию с БД. Параметы в свою очередь передаются для точного определения контекста события. В **component** это параметры переданные в компонент при вызове. В **mysqldb** это может быть sql запрос или результат в виде количества строк.

События **framework**, **template**, **page** параметров не имеют, но имя события **template** обозначает имя выбранного шаблона, а имя **page** выбранной страницы.

# Запуск режима тестирования производительности #

Чтобы увидеть отчет о производительности генерации страницы, необходимо к URL добавить **GET** параметр **z\_performance=1**. После загрузки страницы, отчет будет выведен автоматически.

# Свои события #

Помимо вышеприведенных событий вы можете использовать и свои, путем вызова методов класса Z\_Performance.

Событие всегда должно иметь начало и конец для корректной работы. События одного и того же типа могут быть вложенными. Например, у нас есть свое событие типа "myevent1". Если оно будет вызываться в программе несколько раз, каждое вложенное событие должно закончится до окончания своих родительских событий. Если этого правила не соблюдать можно получить неверные отчеты.

Чтобы начать событие необходимо вызвать следующий код:
```
if(Z_Performance::isEnabled())
   Z_Performance::startEvent("myevent1", "my ivent name", $myparams);
```

Чтобы закончить событие необходимо вызвать следующий код:
```
if(Z_Performance::isEnabled())
   Z_Performance::endEvent("mysql_db", $myparams = false, $add_params = false));
```

Перед вызовом функций всегда должна быть проверка включен ли тест на производительность (**Z\_Performance::isEnabled()**).

В начало или конец события можно передать любые параметры, которые будут видны в отчете. Это может быть как строка так и массив.

Если при завершении события передать **$myparams**, то параметры переданные при начале события будут перезаписаны. Чтобы добавить параметры в конце можно использовать **$add\_params** - массив который будет добавлен в изначальный массив переданный при запуске события. При закрытии события параметры можно не указывать, достаточно просто указать тип события.
# Компоненты ZedCMS #

Компонент фреймворка ZedCMS выполняет функцию контроллера и вывода паттерна MVC.

Компонент можно представить как черный ящик, который имеет входные параметры, внутреннюю логику и HTML или любой другой код или текст как выход.

Как было описано в [концепции фреймворка](FrameworkConcept.md) вся страница разбивается на блоки (напр. меню, статьи, баннеры), а блоки в свою очередь реализуются посредством компонентов, одним или несколькими.

# Внутренняя структура компонента #

Компонент состоит из двух файлов:
  * component.php (обработчик)
  * template1.php (шаблон, может быть несколько)
Шаблон может так же находится в подпапке компонента, тогда название шаблона будет соответствовать названию подпапки, а сам файл шаблона должен называться **template.php**.

# Размещение компонента #
Компонент размещается в папке /components/ сайта или самого фреймворка. Если компонент размещен в папке фреймворка, он будет доступен для всех сайтов. Если в папке определенного сайта, то компонент будет доступен только для этого сайта.

При подключении компонента, фреймворк будет сначала искать его в папке сайта, и если он не будет найден, будет произведен поиск в папке фреймворка. Если компонент нигде не будет найден, возникнет исключение и дальнейшая работа будет прекращена.

Таким образом, можно переопределять компоненты фреймворка ZedCMS своими компонентами, просто скопировав название, но разместив в папке своего сайта.

# Правила наименования компонентов #
Примеры названия компонентов:
  * user.login
  * z:user.login
  * mycomps:user.login

Название компонента определяет папку его нахождения относительно папки components.
Если сайт находится в папке /myuser/www.site1.com/ то вышеуказанные компоненты должны находится в папках:
  * /myuser/www.site1.com/components/user.login
  * /myuser/www.site1.com/components/z/user.login
  * /myuser/www.site1.com/components/mycomps/user.login

Таким образом, компоненты можно организовывать в папки, путем добавления ":" в их названия.

Пример структуры файлов компонента:

```
Шаблон находится на том же уровне, что и обработчик:
/myuser/www.site1.com/components/user.login/component.php
/myuser/www.site1.com/components/user.login/template1.php

Шаблон находится в подпапке компонента:
/myuser/www.site1.com/components/user.login/component.php
/myuser/www.site1.com/components/user.login/template1/template.php
```

# Вызов компонента #

За работу компонента, отвечает библиотека фреймворка Z\_Component и его вызов осуществляется через нее. Примеры:
```
Z_Component::placeComponent("z:user.login", "template1", array(
   "default_user_name" => "anonymous",
   "default_remember_me" => false
));

Z_Component::placeComponent("z:user.login", "", array(
   "default_user_name" => "anonymous",
   "default_remember_me" => false
));
```

В первом вызове указан шаблон компонента "temaplate1", во втором шаблон не указан. Во втором случае фреймворк будет искать шаблон template.php в подпапке компонента ".default". Не рекомендуем использовать компоненты без названия шаблонов, это приводит к запутанности кода.

Третьим параметром указывается массив входных данных компонента.

# Выполнение компонента #
В результате вызова компонента, фреймворк запустит файл component.php и передаст в него массив **$arParams** заполненный массивом, который передан третьим параметром при вызове компонента, при чем **$arParams** будет доступен внутри component.php как глобальная переменная (но при этом она глобальной переменной не является).

Обработчик компонента должен сформировать нейкий **$arResult** массив и самостоятельно инициировать запуск шаблона компонента (обычно в конце component.php). Это делается с помощью следующего кода:

```
$this->drawTemplate(&$arParams,&$arResult);
```

При этом будет запущен файл шаблона и в нем будут доступны два массива **$arParams** и **$arResult**, которые были в обработчике компонента.

В шаблоне можно напрямую выводить HTML код, текст, что угодно просто за пределами тегов PHP или с помощью команд _echo_, _print_ и т.д. В итоге эти данные будут выведены в месте вызова компонента. Выводить данные в обработчике компонента строго запрещено, это противоречит концепции MVC.

Чтобы запретить вывод шаблона компонента в выходной буффер php, а вместо этого поместить выведенные данные в переменную необходимо воспользоваться следующим вызовом:
```
$my_login_form = Z_Component::placeComponent("z:user.login", "template1", array(
   "default_user_name" => "anonymous",
   "default_remember_me" => false,
   "__GET_CONTENT" => true
));
```

Таким образом, мы сохранили весь вывод в переменной $my\_login\_form и теперь можем ее вывести в другом месте, или не вывести вовсе.

# Каскадное выполнение #
Иногда блоки сайта разумнее реализовать с помощью нескольких компонент. Чтобы логически их разделить и при необходимости использовать в других блоках или как отдельный блок.

Примером такой задачи может быть блок вывода статьи, в которой имеется галерея картинок.
Разумно будет сделать отдельный компонент, который выводит текст статьи и отдельный компонент, который выводит галерею картинок. И добавить в обработчик компонента текста вызов компонента галереи, сохранив его результат(как описано выше) в массиве **$arResult** и затем вывести его в нужном месте шаблона компонента текста статьи.

Можно решить сделать вызов компонента галереи прямо в шаблоне текста статьи, но тогда не будет возможности закешировать отдельно вывод галереи и вывод текста.

# Кеширование вывода компонента #
Кеширование компонентов на данный момент в ZedCMS не реализовано. Но это можно легко реализовать путем сохранения вывода компонента в хранилище кеша.

# Пример #
Компонент выводит имя пользователя по его ID обернутый в шаблон вывода пользователя.

Содержимое component.php:
```
// Преобразуем id в число (на всякий случай)
$arParams["user_id"] = intVal($arParams["user_id"]);

// Если id != 0 выводим шаблон, иначе просто выходим без вывода.
if($arParams["user_id"]) {
   $arResult["user"] = Z_User::getUserById($arParams["user_id"]);
   // Если пользователь найден выводим шаблон
   if($arResult["user"])
       $this->drawTemplate(&$arParams,&$arResult);
}
```

Содержимое user\_template.php:
```
   <div class="b-user-name"><?=$arResult["user"]["name"] . " " . $arResult["user"]["last_name"]?></div>
```

Вызов компонента:
```
Z_Component::placeComponent("z:user.name", "user_template", array(
   "user_id" => $_GET["user_id"]
));
```

В итоге, если пользователь указан и он найден выведется:
```
<div class="b-user-name">Имя Фамилия</div>
```
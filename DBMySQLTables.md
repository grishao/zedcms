# Создание таблиц mySQL #

Создание таблиц требует особого внимания, так как основные проблемы возникают при транспорте изменений из системы разработки в продуктивную систему.

# Особенности ведения таблиц #

При ведении таблиц возникает ряд задач:
  * автоматическое создание таблицы, в случае ее отсутствия
  * гибкое изменение полей таблиц (имени, типа)
  * сохранность данных при изменении параметров полей
  * гибкое изменение индексов таблицы
  * изменение таблиц при переносе кода из системы разработки в продуктивную систему

Для решения всех этих задач в ZedCMS существует особый механизм ведения таблиц, который релизован в классе (библиотеке) **Z\_DBMaintainTable**

# Как это работает #

Класс **Z\_DBMaintainTable** имеет один публичный метод:
  * **`createOrChangeTable($table_name, $fields_data, $indexes, $engine = "MyISAM")`**

Рассмотрим работу на примере:
```
Z_DBMaintainTable::createOrChangeTable("mytable_name", 
   array(
      array("name" => "id", "id" => 10, "type" => "INT NOT NULL AUTO_INCREMENT"),
      array("name" => "element_id", "id" => 20, "type" => "INT NOT NULL"),
      array("name" => "field_id", "id" => 30, "type" => "INT NOT NULL"),
      array("name" => "value", "id" => 40, "type" => "LONGTEXT NOT NULL"),
      array("name" => "value_int", "id" => 50, "type" => "INT NOT NULL"),
      array("name" => "value_double", "id" => 60, "type" => "DOUBLE PRECISION NOT NULL"),
      array("name" => "idx", "id" => 70, "type" => "INT NOT NULL")
   ),
   array(
      array("fields" => "id", "type" => "PRIMARY KEY"),
      array("name" => "element_id", "fields" => "element_id, field_id", "type" => "INDEX"),
      array("name" => "value_int", "fields" => "value_int", "type" => "INDEX"),
      array("name" => "value_double", "fields" => "value_double", "type" => "INDEX"),
      array("name" => "elements_id_u", "fields" => "element_id, field_id, idx", "type" => "UNIQUE INDEX")
   ));
```

Метод **createOrChangeTable** принимает имя таблицы первым параметром, второй параметр задает поля таблицы и третий индексы таблицы.

Таблицы создается автоматически, если таблица уже создана она проверяется на изменения.

**Внимание!** Метод **createOrChangeTable** необходимо вызывать каждый раз перед работой с таблицей. Это предотвратит обращение к таблице старой версии. Если таблица не была изменена и уже создана в БД, метод **createOrChangeTable** отработает очень быстро и не будет сильно нагружать БД.

Так же такой подход позволит автоматически изменять таблицу в соответствии с новой версией кода.

## Изменение таблицы ##
Для изменения таблицы достаточно поменять параметры вызова метода **createOrChangeTable**, соблюдая следующие правила:
  * id поля не должен изменяться
  * старый тип данных столбца должен быть совместим с новым типом данных столбца, иначе при измении данные столбца будут потеряны. Например, при переводе строковых данных в числовые, при условии, что строки не содержали цифр.

id прописывается в комментариях столбца (на уровне mysql), поэтому запрещено использование комментария в других целях. Это позволяет переименовывать поля с последующим автоматическим обновлением без потери данных.